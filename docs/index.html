<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Netpol Builder</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f3f4f6;
    }

    .app {
      display: flex;
      height: 100vh;
      max-width: 1200px;
      margin: 0 auto;
    }

    #left,
    #right {
      flex: 1 1 0;
      padding: 20px;
      overflow-y: auto;
    }

    #left {
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
    }

    #right {
      background: #f9fafb;
    }

    h2 {
      margin-top: 0;
      font-size: 1.4rem;
    }

    h3 {
      margin-top: 24px;
      font-size: 1.1rem;
    }

    .field {
      margin: 10px 0;
    }

    .field label {
      font-weight: 600;
      font-size: 0.9rem;
      display: inline-block;
      margin-bottom: 4px;
    }

    .field input,
    .field select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      font-size: 0.9rem;
      resize: vertical;
    }

    pre#yaml {
      background: #111827;
      color: #e5e7eb;
      padding: 12px;
      white-space: pre-wrap;
      border-radius: 6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
    }

    button {
      margin: 4px 0;
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #2563eb;
      background: #2563eb;
      color: #ffffff;
      font-size: 0.85rem;
    }

    button:hover {
      background: #1d4ed8;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn-danger {
      border-color: #dc2626;
      background: #dc2626;
    }

    .btn-danger:hover {
      background: #b91c1c;
    }

    .rule-box {
      border: 1px solid #e5e7eb;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
    }

    .icon {
      cursor: pointer;
      margin-left: 6px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .icon:hover {
      color: #dc2626;
    }

    /* Modal */
    #modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(3px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #modalBox {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      width: 320px;
      box-shadow: 0 10px 40px rgba(15, 23, 42, 0.45);
    }

    #modalBox h3 {
      margin-top: 0;
      margin-bottom: 12px;
    }

    #modalBox select,
    #modalBox input {
      width: 100%;
      margin: 8px 0;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
    }

    #modalBox button {
      margin-right: 8px;
    }
  </style>
</head>

<body>

<!-- ====================== MAIN APP LAYOUT ========================== -->
<div class="app">

  <!-- ====================== LEFT PANEL ========================== -->
  <div id="left">
  <h2>Netpol Builder</h2>

  <!-- Namespace -->
  <div class="field">
    <label>Namespace:</label><br>
    <input id="namespace" value="change_me" oninput="renderYAML()" />
  </div>

  <!-- Features -->
  <div class="field">
    <label>ingress:</label>
    <select id="feature-ingress" onchange="renderYAML()">
      <option>true</option>
      <option>false</option>
    </select>
  </div>

  <div class="field">
    <label>monitoring:</label>
    <select id="feature-monitoring" onchange="renderYAML()">
      <option>false</option>
      <option>true</option>
    </select>
  </div>

  <hr>

  <h3>Rules</h3>
  <button onclick="addRule()">+ Add Rule</button>

  <div id="rules"></div>
  </div>

  <!-- ====================== RIGHT PANEL ========================== -->
  <div id="right">
    <h2>Generated YAML</h2>
    <pre id="yaml"></pre>
  </div>

</div>

<!-- ====================== MODAL POP FORM ========================== -->
<div id="modalOverlay">
  <div id="modalBox">
    <h3 id="modalTitle">Add Field</h3>

    <label>Field Type:</label>
    <select id="modalFieldType"></select>

    <div id="modalValueArea">
      <label>Value:</label>
      <input id="modalFieldValue" />
    </div>

    <button onclick="modalSubmit()">Save</button>
    <button onclick="closeModal()">Cancel</button>
  </div>
</div>

<script>
let ruleCounter = 0;
const rules = [];

let modalTarget = null;
let modalSection = null;
let modalEditingKey = null;

// ----------------------- MODAL -------------------------

function openModal(ruleId, section, options, editKey=null) {
  modalTarget = ruleId;
  modalSection = section;
  modalEditingKey = editKey;

  const select = document.getElementById("modalFieldType");
  select.innerHTML = "";

  options.forEach(o => {
    const op = document.createElement("option");
    op.value = o;
    op.textContent = o;
    select.appendChild(op);
  });

  const valueBox = document.getElementById("modalValueArea");
  const valueInput = document.getElementById("modalFieldValue");

  if (editKey) {
    document.getElementById("modalTitle").textContent = "Edit Field";
    select.value = editKey;

    const rule = rules.find(r => r.id === ruleId);

    if (editKey === "any") {
      valueBox.style.display = "none";
    } else {
      valueBox.style.display = "block";
      valueInput.value = rule[section][editKey];
    }
  } else {
    document.getElementById("modalTitle").textContent = "Add Field";
    valueInput.value = "";
    valueBox.style.display = "block";
  }

  select.onchange = () => {
    if (select.value === "any") valueBox.style.display = "none";
    else valueBox.style.display = "block";
  };

  document.getElementById("modalOverlay").style.display = "flex";
}

function closeModal() {
  modalTarget = null;
  modalSection = null;
  modalEditingKey = null;
  document.getElementById("modalOverlay").style.display = "none";
}

function modalSubmit() {
  const type = document.getElementById("modalFieldType").value;
  const val = document.getElementById("modalFieldValue").value;

  const rule = rules.find(r => r.id === modalTarget);
  if (!rule) return;

  // EDIT MODE
  if (modalEditingKey) {
    delete rule[modalSection][modalEditingKey];

    if (type === "any") {
      rule[modalSection] = { any: true };
    } else {
      rule[modalSection][type] = val;
    }
    closeModal();
    renderRules();
    renderYAML();
    return;
  }

  // ADD MODE
  if (type === "any") {
    rule[modalSection] = { any: true };
  } else {
    rule[modalSection][type] = val;
  }

  closeModal();
  renderRules();
  renderYAML();
}

// ------------------------ RULE MGMT ----------------------

function addRule() {
  const id = ruleCounter++;
  rules.push({ id, src: {}, dst: {}, service: "", description: "" });
  renderRules();
  renderYAML();
}

function removeRule(id) {
  const idx = rules.findIndex(r => r.id === id);
  if (idx >= 0) rules.splice(idx, 1);
  renderRules();
  renderYAML();
}

function removeField(ruleId, section, key) {
  const rule = rules.find(r => r.id === ruleId);
  if (!rule) return;
  delete rule[section][key];
  renderRules();
  renderYAML();
}

function openSrcAddForm(ruleId) {
  openModal(ruleId, "src", ["workload", "namespace", "any"]);
}

function openDstAddForm(ruleId) {
  openModal(ruleId, "dst", ["workload", "namespace", "fqdn", "cidr", "any"]);
}

function editField(ruleId, section, key) {
  const opts = (section === "src")
    ? ["workload", "namespace", "any"]
    : ["workload", "namespace", "fqdn", "cidr", "any"];

  openModal(ruleId, section, opts, key);
}

function updateRuleField(id, section, key, value) {
  const rule = rules.find(r => r.id === id);
  if (!rule) return;
  if (!value) delete rule[section][key];
  else rule[section][key] = value;
  renderYAML();
}

function updateRuleMeta(id, key, value) {
  const rule = rules.find(r => r.id === id);
  rule[key] = value;
  renderYAML();
}

// ---------------------- VALIDATION RULES ----------------------

function validateRule(rule) {
  const errors = [];

  const src = rule.src || {};
  const dst = rule.dst || {};

  const srcAny = !!src.any;
  const srcWorkload = !!src.workload;
  const srcNamespace = !!src.namespace;

  if (srcAny && (srcWorkload || srcNamespace)) {
    errors.push("src: cannot combine 'any' with 'namespace' or 'workload'.");
  }

  if (srcNamespace && !srcWorkload) {
    errors.push("src: 'namespace' requires 'workload'.");
  }

  if (!srcAny && !srcWorkload && !srcNamespace) {
    errors.push("src: must set either 'any' or 'workload' (optionally with namespace).");
  }

  const dstAny = !!dst.any;
  const dstWorkload = !!dst.workload;
  const dstNamespace = !!dst.namespace;
  const dstFqdn = !!dst.fqdn;
  const dstCidr = !!dst.cidr;

  const modeCount = [dstAny, dstWorkload, dstFqdn, dstCidr].filter(Boolean).length;

  if (modeCount === 0) {
    errors.push("dst: must set one of 'any', 'workload', 'fqdn', or 'cidr'.");
  }

  if (modeCount > 1) {
    errors.push("dst: choose only one of 'any', 'workload', 'fqdn', or 'cidr'.");
  }

  if (dstAny && (dstWorkload || dstNamespace || dstFqdn || dstCidr)) {
    errors.push("dst: 'any' cannot be combined with other fields.");
  }

  if (dstFqdn && (dstAny || dstWorkload || dstNamespace || dstCidr)) {
    errors.push("dst: 'fqdn' cannot be combined with 'any', 'workload', 'namespace', or 'cidr'.");
  }

  if (dstCidr && (dstAny || dstWorkload || dstNamespace || dstFqdn)) {
    errors.push("dst: 'cidr' cannot be combined with 'any', 'workload', 'namespace', or 'fqdn'.");
  }

  if (dstNamespace && !dstWorkload) {
    errors.push("dst: 'namespace' requires 'workload'.");
  }

  return errors;
}

// ------------------ ID GENERATION -----------------------

function normalize(str) {
  return (str || "")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-|-$/g, "");
}

function generateId(rule) {
  let src = "any";
  if (rule.src.workload) src = rule.src.workload;
  else if (rule.src.namespace && rule.src.workload)
    src = rule.src.namespace + "-" + rule.src.workload;

  let dst = "any";
  if (rule.dst.workload) dst = rule.dst.workload;
  else if (rule.dst.namespace && rule.dst.workload)
    dst = rule.dst.namespace + "-" + rule.dst.workload;
  else if (rule.dst.fqdn) dst = rule.dst.fqdn;
  else if (rule.dst.cidr) dst = rule.dst.cidr;

  const svc = rule.service ? normalize(rule.service) : "";
  return normalize(src) + "-to-" + normalize(dst) + (svc ? "-" + svc : "");
}

// ----------------------- RENDERING -----------------------

function renderRules() {
  const container = document.getElementById("rules");
  container.innerHTML = "";

  rules.forEach(rule => {
    const div = document.createElement("div");
    div.className = "rule-box";

    const autoId = generateId(rule);
    const errors = validateRule(rule);

    const srcFields = Object.entries(rule.src).map(([k,v]) => {
      if (k === "any")
        return `any: true 
          <span class="icon" onclick="editField(${rule.id}, 'src', '${k}')">✏️</span>
          <span class="icon" onclick="removeField(${rule.id}, 'src', '${k}')">✖</span><br>`;

      return `${k}: <input value="${v}" oninput="updateRuleField(${rule.id}, 'src', '${k}', this.value)" />
        <span class="icon" onclick="editField(${rule.id}, 'src', '${k}')">✏️</span>
        <span class="icon" onclick="removeField(${rule.id}, 'src', '${k}')">✖</span><br>`;
    }).join("");

    const dstFields = Object.entries(rule.dst).map(([k,v]) => {
      if (k === "any")
        return `any: true 
          <span class="icon" onclick="editField(${rule.id}, 'dst', '${k}')">✏️</span>
          <span class="icon" onclick="removeField(${rule.id}, 'dst', '${k}')">✖</span><br>`;

      return `${k}: <input value="${v}" oninput="updateRuleField(${rule.id}, 'dst', '${k}', this.value)" />
        <span class="icon" onclick="editField(${rule.id}, 'dst', '${k}')">✏️</span>
        <span class="icon" onclick="removeField(${rule.id}, 'dst', '${k}')">✖</span><br>`;
    }).join("");

    const errorsHtml = errors.length
      ? `<div style="color:#b91c1c; margin-top:8px; font-size:0.8rem;">
           ${errors.map(e => `• ${e}`).join("<br>")}
         </div>`
      : "";

    div.innerHTML = `
      <b>ID (auto):</b> ${autoId}<br><br>

      <b>SOURCE:</b><br>
      ${srcFields}
      <button onclick="openSrcAddForm(${rule.id})">+ Add SRC Field</button>

      <br><br>

      <b>DESTINATION:</b><br>
      ${dstFields}
      <button onclick="openDstAddForm(${rule.id})">+ Add DST Field</button>

      <br><br>

      Service:<br>
      <input value="${rule.service}" oninput="updateRuleMeta(${rule.id}, 'service', this.value)" /><br><br>

      Description:<br>
      <textarea oninput="updateRuleMeta(${rule.id}, 'description', this.value)">${rule.description}</textarea><br>

      <button class="btn-danger" onclick="removeRule(${rule.id})">Remove Rule</button>

      ${errorsHtml}
    `;

    container.appendChild(div);
  });
}

function renderYAML() {
  const ns = document.getElementById("namespace").value;
  const ingress = document.getElementById("feature-ingress").value === "true";
  const monitoring = document.getElementById("feature-monitoring").value === "true";

  const validRules = rules.filter(r => validateRule(r).length === 0);

  const yamlObj = {
    namespace: ns,
    features: { ingress, monitoring },
    selectors: {},
    rules: validRules.map(r => {
      const autoId = generateId(r);

      const rule = {
        id: autoId,
        src: r.src,
        dst: { ...r.dst }   // clone dst first
      };

      // FIX: service belongs inside dst
      if (r.service) rule.dst.service = r.service;

      if (r.description) rule.description = r.description;

      return rule;
    })
  };

  document.getElementById("yaml").textContent = yamlDump(yamlObj);
}

function yamlDump(obj, indent = 0) {
  const pad = "  ".repeat(indent);
  if (obj === null) return "null";

  if (typeof obj !== "object") {
    const s = obj.toString();
    if (/[:\s\/]/.test(s)) {
      return '"' + s.replace(/"/g, '\\"') + '"';
    }
    return s;
  }

  if (Array.isArray(obj)) {
    if (obj.length === 0) return "[]";
    return obj
      .map(item => {
        if (item === null || typeof item !== "object") {
          return pad + "- " + yamlDump(item, indent + 1);
        } else {
          const body = yamlDump(item, indent + 1);
          const [first, ...rest] = body.split("\n");
          return [pad + "- " + first.trimStart(), ...rest].join("\n");
        }
      })
      .join("\n");
  }

  return Object.entries(obj)
    .map(([k, v]) => {
      if (v === undefined) return "";
      if (v !== null && typeof v === "object") {
        const nested = yamlDump(v, indent + 1);
        return pad + k + ":\n" + nested;
      }
      return pad + k + ": " + yamlDump(v, indent + 1);
    })
    .filter(Boolean)
    .join("\n");
}

renderYAML();
</script>

</body>
</html>